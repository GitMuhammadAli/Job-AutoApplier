{
  "name": "04 - Email Parser (Interview Detector)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "minutes", "minutesInterval": 30 }]
        }
      },
      "name": "Every 30 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [220, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "getAll",
        "returnAll": false,
        "limit": 20,
        "filters": {
          "q": "subject:(interview OR schedule OR invitation OR assessment OR coding test OR technical round) newer_than:1d -category:promotions -category:social",
          "labelIds": ["INBOX"],
          "includeSpamTrash": false
        },
        "options": { "format": "full" }
      },
      "name": "Fetch Recent Emails (Gmail)",
      "type": "n8n-nodes-base.gmail",
      "position": [440, 300],
      "credentials": { "gmailOAuth2": { "id": "GMAIL_CREDENTIALS_ID", "name": "Gmail" } }
    },
    {
      "parameters": {
        "jsCode": "const emails = $input.all();\nconst results = [];\n\nconst interviewKeywords = ['interview', 'schedule', 'assessment', 'coding test', 'technical round', 'phone screen', 'meet the team', 'next steps', 'hiring process'];\n\nfor (const email of emails) {\n  const subject = (email.json.subject || '').toLowerCase();\n  const body = (email.json.text || email.json.snippet || '').toLowerCase();\n  const from = email.json.from || '';\n  const fullText = subject + ' ' + body;\n  \n  const isInterview = interviewKeywords.some(k => fullText.includes(k));\n  \n  if (isInterview) {\n    // Try to extract company name from sender\n    const companyMatch = from.match(/@([^.]+)\\./)?.[1] || 'Unknown';\n    const company = companyMatch.charAt(0).toUpperCase() + companyMatch.slice(1);\n    \n    // Try to extract date/time\n    const dateMatch = fullText.match(/(\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4})/) ||\n                      fullText.match(/(monday|tuesday|wednesday|thursday|friday|saturday|sunday)[,\\s]+(\\w+ \\d{1,2})/i);\n    \n    results.push({\n      json: {\n        company,\n        senderEmail: from,\n        subject: email.json.subject,\n        possibleDate: dateMatch ? dateMatch[0] : null,\n        snippet: (email.json.snippet || '').substring(0, 300),\n        emailId: email.json.id,\n        receivedAt: email.json.date\n      }\n    });\n  }\n}\n\nreturn results.length > 0 ? results : [{ json: { noInterviews: true } }];"
      },
      "name": "Detect Interview Emails",
      "type": "n8n-nodes-base.code",
      "position": [660, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{ "value1": "={{ $json.noInterviews }}", "value2": true, "operation": "notEqual" }]
        }
      },
      "name": "Found Interviews?",
      "type": "n8n-nodes-base.if",
      "position": [880, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.APP_URL || 'http://app:3000' }}/api/webhooks/n8n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-n8n-secret", "value": "={{ $env.N8N_WEBHOOK_SECRET }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"action\": \"interview_detected\",\n  \"company\": \"{{ $json.company }}\",\n  \"senderEmail\": \"{{ $json.senderEmail }}\",\n  \"subject\": \"{{ $json.subject }}\",\n  \"possibleDate\": \"{{ $json.possibleDate }}\",\n  \"snippet\": \"{{ $json.snippet }}\"\n}",
        "options": {}
      },
      "name": "Notify Job Tracker",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1100, 200]
    }
  ],
  "connections": {
    "Every 30 Minutes": { "main": [[{ "node": "Fetch Recent Emails (Gmail)" }]] },
    "Fetch Recent Emails (Gmail)": { "main": [[{ "node": "Detect Interview Emails" }]] },
    "Detect Interview Emails": { "main": [[{ "node": "Found Interviews?" }]] },
    "Found Interviews?": { "main": [[{ "node": "Notify Job Tracker" }], []] }
  },
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "job-tracker" }]
}
